<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/><meta content="no-referrer" name="referrer"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>р╕гр╕░р╕Ър╕Ър╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Зр╕▓р╕Щр╕Лр╣Ир╕нр╕б</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style> body { font-family: 'Kanit', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
<div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
<div class="bg-blue-600 p-6 text-white">
<h2 class="text-xl font-bold text-center mb-2">ЁЯФз р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Гр╕Ър╕Зр╕▓р╕Щр╕Лр╣Ир╕нр╕б</h2>
<div class="bg-blue-500 rounded-lg p-4 text-sm space-y-2">
<p><strong>ЁЯФв р╣Ар╕ер╕Вр╕Чр╕╡р╣Ир╣Гр╕Ър╕Зр╕▓р╕Щ:</strong> <span id="showCaseId">...</span></p>
<p><strong>ЁЯСд р╕Ьр╕╣р╣Йр╣Бр╕Ир╣Йр╕З:</strong> <span id="showName">...</span></p>
<p><strong>ЁЯУЮ р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г:</strong> <a class="underline text-yellow-300" href="#" id="callLink">р╕Бр╕Фр╣Ар╕Юр╕╖р╣Ир╕нр╣Вр╕Чр╕гр╕нр╕нр╕Б</a></p>
<p><strong>ЁЯУЭ р╕нр╕▓р╕Бр╕▓р╕г:</strong> <span id="showDetail">...</span></p>
</div>
</div>
<!-- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕бр╕кр╣Ир╕зр╕Щр╣Бр╕кр╕Фр╕Зр╕гр╕╣р╕Ыр╕лр╕Щр╣Йр╕▓р╕Зр╕▓р╕Щ + р╣Бр╕Ьр╕Щр╕Чр╕╡р╣И (р╕гр╕▒р╕Ър╕Др╣Ир╕▓р╕Ир╕▓р╕Бр╕ер╕┤р╕Зр╕Бр╣М) -->
<div class="bg-white p-4 border-b space-y-4">
<div>
<p class="font-bold text-gray-700 mb-2">ЁЯУ╕ р╕гр╕╣р╕Ыр╕лр╕Щр╣Йр╕▓р╕Зр╕▓р╕Щ</p>
<img alt="р╕гр╕╣р╕Ыр╕лр╕Щр╣Йр╕▓р╕Зр╕▓р╕Щ" class="hidden w-full rounded-lg border shadow" crossorigin="anonymous" id="issuePhoto" referrerpolicy="no-referrer"/>
<p class="text-sm text-gray-500" id="noIssuePhoto">р╣Др╕бр╣Ир╕бр╕╡р╕гр╕╣р╕Ыр╣Бр╕Щр╕Ър╣Гр╕Щр╕ер╕┤р╕Зр╕Бр╣М</p><p class="hidden text-sm text-red-600" id="issuePhotoError">р╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И <a class="underline" href="#" id="issuePhotoOpen" rel="noopener" target="_blank">р╕Бр╕Фр╣Ар╕Ыр╕┤р╕Фр╕гр╕╣р╕Ы</a></p>
</div>
<div>
<p class="font-bold text-gray-700 mb-2">ЁЯЧ║я╕П р╣Бр╕Ьр╕Щр╕Чр╕╡р╣И</p>
<a class="block w-full text-center bg-blue-50 text-blue-700 font-bold py-2 rounded-lg" id="mapLink" rel="noopener" target="_blank">р╣Ар╕Ыр╕┤р╕Фр╣Бр╕Ьр╕Щр╕Чр╕╡р╣Ир╣Гр╕Щ Google Maps</a>
<iframe class="hidden w-full h-56 mt-2 rounded-lg border" id="mapFrame" loading="lazy"></iframe>
<p class="hidden text-sm text-gray-500 mt-1" id="noLocation">р╣Др╕бр╣Ир╕бр╕╡р╕Юр╕┤р╕Бр╕▒р╕Фр╣Бр╕Щр╕Ър╣Гр╕Щр╕ер╕┤р╕Зр╕Бр╣М</p>
</div>
</div>
<form class="p-6 space-y-6" id="techForm">
<input id="caseId" name="caseId" type="hidden"/>
<input id="userId" name="userId" type="hidden"/>
<input id="actionType" name="actionType" type="hidden"/>
<input id="lat" name="lat" type="hidden"/>
<input id="long" name="long" type="hidden"/>
<input id="photoUrl" name="photoUrl" type="hidden"/>
<input id="afterPhotoUrl" name="afterPhotoUrl" type="hidden"/>
<div class="border-b pb-6">
<h3 class="font-bold text-gray-700 mb-2">1. р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Кр╣Ир╕▓р╕Зр╕гр╕▒р╕Ър╣Ар╕гр╕╖р╣Ир╕нр╕З</h3>
<button class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow transition flex justify-center items-center gap-2" onclick="submitForm('accept')" type="button">
                    ЁЯЪз р╕Бр╕Фр╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ър╕Зр╕▓р╕Щ (р╣Бр╕Ир╣Йр╕Зр╕Кр╕▓р╕зр╕Ър╣Йр╕▓р╕Щр╕зр╣Ир╕▓р╕Бр╕│р╕ер╕▒р╕Зр╣Др╕Ы)
                </button>
</div>
<div>
<h3 class="font-bold text-gray-700 mb-2">2. р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Кр╣Ир╕▓р╕Зр╕кр╣Ир╕Зр╕Зр╕▓р╕Щ (р╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з)</h3>
<label class="block text-sm text-gray-600 mb-1">р╕гр╕╣р╕Ыр╕Цр╣Ир╕▓р╕вр╕лр╕ер╕▒р╕Зр╕Лр╣Ир╕нр╕бр╣Ар╕кр╕гр╣Зр╕И *</label>
<input accept="image/*" class="w-full mb-3 text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700" id="imageInput" name="image" type="file"/>
<textarea class="w-full border rounded-lg p-2 mb-3" id="message" name="message" placeholder="р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Цр╕╢р╕Зр╕Кр╕▓р╕зр╕Ър╣Йр╕▓р╕Щ (р╣Ар╕Кр╣Ир╕Щ р╕Лр╣Ир╕нр╕бр╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕зр╕Др╕гр╕▒р╕Ъ)" rows="2"></textarea>
<button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition flex justify-center items-center gap-2" onclick="submitForm('finish')" type="button">
                    тЬЕ р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Ыр╕┤р╕Фр╕Зр╕▓р╕Щ (р╕кр╣Ир╕Зр╕гр╕╣р╕Ыр╣Гр╕лр╣Йр╕Кр╕▓р╕зр╕Ър╣Йр╕▓р╕Щ)
                </button>
</div>
</form>
</div>
<div class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" id="loading">
<div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
</div>
<script>
        // тЪая╕П р╣Гр╕кр╣И Webhook р╕нр╕▒р╕Щр╣Гр╕лр╕бр╣Ир╕кр╕│р╕лр╕гр╕▒р╕Ър╕Кр╣Ир╕▓р╕З р╕Хр╕гр╕Зр╕Щр╕╡р╣Й
        const WEBHOOK_URL = 'https://hook.eu1.make.com/9mgmk9fvut2zuu9ermdqocvkmnh5na9z';

        // тЬЕ р╣Гр╕кр╣И API Key р╕Вр╕нр╕З ImgBB (р╕лр╣Йр╕▓р╕бр╣Ар╕Ьр╕вр╣Бр╕Юр╕гр╣Ир╕Др╕╡р╕вр╣Мр╕Щр╕╡р╣Й)
        const IMGBB_API_KEY = '90bdd186ac4a75a080d137e88c123b84';

        function fileToBase64(file){
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = String(reader.result).split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function uploadToImgBB(file){
            const base64 = await fileToBase64(file);
            const fd = new FormData();
            fd.append('image', base64);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: fd
            });
            const data = await res.json();
            if(!data || !data.success) throw new Error('ImgBB upload failed');
            return data.data.url;
        }
 

        // р╕Фр╕╢р╕Зр╕Др╣Ир╕▓р╕Ир╕▓р╕Бр╕ер╕┤р╕Зр╕Др╣Мр╕бр╕▓р╣Вр╕Кр╕зр╣Мр╕Хр╕нр╕Щр╣Ар╕Ыр╕┤р╕Фр╣Ар╕зр╣Зр╕Ъ
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            // тЬЕ р╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕бр╕▓р╕Бр╕▒р╕Ъ URL (р╕Бр╕▒р╕Щр╕зр╕Зр╣Ар╕ер╣Зр╕Ъ/р╕Кр╣Ир╕нр╕Зр╕зр╣Ир╕▓р╕З/р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Ыр╕Щ)
            const cleanParam = (v) => (v || '').toString().trim().replace(/^[\s(]+|[\s)]+$/g,'');
            const getParam = (k) => cleanParam(params.get(k));

            document.getElementById('showCaseId').innerText = getParam('id') || '-';
            document.getElementById('showName').innerText = getParam('name') || '-';
            document.getElementById('showDetail').innerText = getParam('detail') || '-';
            
            // р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Ыр╕╕р╣Ир╕бр╣Вр╕Чр╕гр╕нр╕нр╕Б
            const phone = getParam('phone') || '';
            document.getElementById('callLink').innerText = phone;
            document.getElementById('callLink').href = 'tel:' + phone;

            // р╣Ар╕Бр╣Зр╕Ър╕Др╣Ир╕▓р╣Гр╕кр╣Ир╕Бр╕ер╣Ир╕нр╕Зр╕Лр╣Ир╕нр╕Щ р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕кр╣Ир╕З
            document.getElementById('caseId').value = getParam('id');
            document.getElementById('userId').value = (getParam('userid') || getParam('userId') || getParam('userID'));
            // тЬЕ р╣Ар╕Бр╣Зр╕Ър╕Юр╕┤р╕Бр╕▒р╕Ф/р╕гр╕╣р╕Ыр╕лр╕Щр╣Йр╕▓р╕Зр╕▓р╕Щр╣Др╕зр╣Йр╣Гр╕Щр╕Яр╕нр╕гр╣Мр╕б
            const lat = getParam('lat') || '';
            const lng = getParam('long') || '';
            let photo = getParam('photo') || getParam('photoUrl') || '';
            // р╕Цр╣Йр╕▓р╕гр╕╣р╕Ыр╣Др╕бр╣Ир╕бр╕╡ http/https р╣Гр╕лр╣Йр╣Ар╕Хр╕┤р╕б https:// р╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щр╕ер╕┤р╕Зр╕Бр╣Мр╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М
            if(photo && !/^https?:\/\//i.test(photo)){
                photo = 'https://' + photo.replace(/^\/+/, '');
            }
            document.getElementById('lat').value = lat;
            document.getElementById('long').value = lng;
            document.getElementById('photoUrl').value = photo;

            // тЬЕ р╣Бр╕кр╕Фр╕Зр╕гр╕╣р╕Ыр╕лр╕Щр╣Йр╕▓р╕Зр╕▓р╕Щ
            const issuePhoto = document.getElementById('issuePhoto');
            // р╕Бр╕▒р╕Щр╕Ър╕▓р╕Зр╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╕Ър╕ер╣Зр╕нр╕Д hotlink/referrer
            try{ issuePhoto.referrerPolicy = 'no-referrer'; }catch(e){}
            const noIssuePhoto = document.getElementById('noIssuePhoto');
            const issuePhotoError = document.getElementById('issuePhotoError');
            const issuePhotoOpen = document.getElementById('issuePhotoOpen');

            // р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕кр╕Цр╕▓р╕Щр╕░
            issuePhoto.classList.add('hidden');
            noIssuePhoto.classList.remove('hidden');
            if(issuePhotoError) issuePhotoError.classList.add('hidden');

            if(photo){
                // р╕Цр╣Йр╕▓р╕бр╕╡р╕гр╕╣р╕Ы р╣Гр╕лр╣Йр╕Юр╕вр╕▓р╕вр╕▓р╕бр╣Бр╕кр╕Фр╕З
                issuePhoto.onload = function(){
                    issuePhoto.classList.remove('hidden');
                    noIssuePhoto.classList.add('hidden');
                    if(issuePhotoError) issuePhotoError.classList.add('hidden');
                };

                issuePhoto.onerror = function(){
                    // р╕ер╕нр╕Зр╕Ьр╣Ир╕▓р╕Щ proxy 1 р╕Др╕гр╕▒р╣Йр╕З р╣Ар╕Ьр╕╖р╣Ир╕нр╣Вр╕Фр╕Щр╕Ър╕ер╣Зр╕нр╕Д hotlink
                    if(!issuePhoto.dataset.triedProxy){
                        issuePhoto.dataset.triedProxy = '1';
                        const clean = photo.replace(/^https?:\/\//,'');
                        issuePhoto.src = 'https://images.weserv.nl/?url=' + encodeURIComponent(clean);
                        return;
                    }
                    // р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Й р╣Гр╕лр╣Йр╣Вр╕Кр╕зр╣Мр╕ер╕┤р╕Зр╕Бр╣Мр╣Ар╕Ыр╕┤р╕Фр╕гр╕╣р╕Ыр╣Бр╕Чр╕Щ
                    issuePhoto.classList.add('hidden');
                    noIssuePhoto.classList.add('hidden');
                    if(issuePhotoError){
                        issuePhotoError.classList.remove('hidden');
                        if(issuePhotoOpen) issuePhotoOpen.href = photo;
                    }
                };

                // р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ src (р╕гр╕нр╕Ър╣Бр╕гр╕Б)
                issuePhoto.dataset.triedProxy = '';
                issuePhoto.src = photo;
            }
            // тЬЕ р╣Бр╕кр╕Фр╕Зр╣Бр╕Ьр╕Щр╕Чр╕╡р╣И
            const mapLink = document.getElementById('mapLink');
            const mapFrame = document.getElementById('mapFrame');
            const noLocation = document.getElementById('noLocation');
            if(lat && lng){
                const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                mapLink.href = mapUrl;
                mapFrame.src = `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
                mapFrame.classList.remove('hidden');
            } else {
                mapLink.href = '#';
                mapLink.classList.add('opacity-50','pointer-events-none');
                noLocation.classList.remove('hidden');
            }

        };

        // р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е
        async function submitForm(type) {
            document.getElementById('actionType').value = type; // р╕Ър╕нр╕Бр╕гр╕░р╕Ър╕Ър╕зр╣Ир╕▓р╕Бр╕Фр╕Ыр╕╕р╣Ир╕бр╣Др╕лр╕Щ (accept р╕лр╕гр╕╖р╕н finish)
            
            // р╕Цр╣Йр╕▓р╕Бр╕Фр╕Ыр╕┤р╕Фр╕Зр╕▓р╕Щ р╕Хр╣Йр╕нр╕Зр╣Ар╕Кр╣Зр╕Др╕гр╕╣р╕Ы
            if(type === 'finish') {
                const img = document.getElementById('imageInput');
                if(img.files.length === 0) { Swal.fire('р╕ер╕╖р╕бр╕гр╕╣р╕Ы', 'р╕Хр╣Йр╕нр╕Зр╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╕Зр╕▓р╕Щр╣Ар╕кр╕гр╣Зр╕Ир╕Бр╣Ир╕нр╕Щр╕Др╕гр╕▒р╕Ъ', 'warning'); return; }
            }

            document.getElementById('loading').classList.remove('hidden');
            const formData = new FormData(document.getElementById('techForm'));

            try {
                // тЬЕ р╕Цр╣Йр╕▓р╕Ыр╕┤р╕Фр╕Зр╕▓р╕Щ р╣Гр╕лр╣Йр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ыр╕лр╕ер╕▒р╕Зр╕Лр╣Ир╕нр╕бр╣Др╕Ы ImgBB р╣Бр╕ер╣Йр╕зр╕кр╣Ир╕Зр╣Ар╕Ыр╣Зр╕Щ URL (р╣Др╕бр╣Ир╕кр╣Ир╕Зр╣Др╕Яр╕ер╣Мр╣Ар╕Вр╣Йр╕▓ Make)
                if(type === 'finish'){
                    const img = document.getElementById('imageInput');
                    const afterUrl = await uploadToImgBB(img.files[0]);
                    document.getElementById('afterPhotoUrl').value = afterUrl;

                    formData.set('afterPhotoUrl', afterUrl);
                    formData.delete('image');
                }

                await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
                Swal.fire('р╕кр╕│р╣Ар╕гр╣Зр╕И', 'р╕гр╕░р╕Ър╕Ър╣Др╕Фр╣Йр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Кр╕▓р╕зр╕Ър╣Йр╕▓р╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з', 'success').then(() => window.close());
            } catch (err) {
                Swal.fire('Error', 'р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И', 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
