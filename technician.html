<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8"/><meta content="no-referrer" name="referrer"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style> body { font-family: 'Kanit', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-blue-600 p-6 text-white">
            <h2 class="text-xl font-bold text-center mb-2">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h2>
            <div class="bg-blue-500 rounded-lg p-4 text-sm space-y-2">
                <p><strong>üî¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏á‡∏≤‡∏ô:</strong> <span id="showCaseId">...</span></p>
                <p><strong>üë§ ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> <span id="showName">...</span></p>
                <p><strong>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> <a class="underline text-yellow-300" href="#" id="callLink">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ó‡∏£‡∏≠‡∏≠‡∏Å</a></p>
                <p><strong>üìù ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:</strong> <span id="showDetail">...</span></p>
            </div>
        </div>

        <div class="bg-white p-4 border-b space-y-4">
            <div>
                <p class="font-bold text-gray-700 mb-2">üì∏ ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</p>
                <img alt="‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô" class="hidden w-full rounded-lg border shadow" crossorigin="anonymous" id="issuePhoto" referrerpolicy="no-referrer"/>
                <p class="text-sm text-gray-500" id="noIssuePhoto">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ö‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå</p>
                <p class="hidden text-sm text-red-600" id="issuePhotoError">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à <a class="underline" href="#" id="issuePhotoOpen" rel="noopener" target="_blank">‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏π‡∏õ</a></p>
            </div>
            <div>
                <p class="font-bold text-gray-700 mb-2">üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>
                <a class="block w-full text-center bg-blue-50 text-blue-700 font-bold py-2 rounded-lg" id="mapLink" rel="noopener" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô Google Maps</a>
                <iframe class="hidden w-full h-56 mt-2 rounded-lg border" id="mapFrame" loading="lazy"></iframe>
                <p class="hidden text-sm text-gray-500 mt-1" id="noLocation">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ô‡∏ö‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå</p>
            </div>
        </div>

        <form class="p-6 space-y-6" id="techForm">
            <input id="caseId" name="caseId" type="hidden"/>
            <input id="userId" name="userId" type="hidden"/>
            <input id="actionType" name="actionType" type="hidden"/>
            <input id="lat" name="lat" type="hidden"/>
            <input id="long" name="long" type="hidden"/>
            <input id="photoUrl" name="photoUrl" type="hidden"/>
            <input id="afterPhotoUrl" name="afterPhotoUrl" type="hidden"/>

            <div class="border-b pb-6">
                <h3 class="font-bold text-gray-700 mb-2">1. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h3>
                <button id="btnAccept" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow transition flex justify-center items-center gap-2" onclick="submitForm('accept')" type="button">
                    üöß ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ)
                </button>
            </div>

            <div>
                <h3 class="font-bold text-gray-700 mb-2">2. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô (‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)</h3>
                <label class="block text-sm text-gray-600 mb-1">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à *</label>
                <input accept="image/*" class="w-full mb-3 text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700" id="imageInput" name="image" type="file"/>
                <textarea class="w-full border rounded-lg p-2 mb-3" id="message" name="message" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö)" rows="2"></textarea>
                <button id="btnFinish" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow transition flex justify-center items-center gap-2" onclick="submitForm('finish')" type="button">
                    ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô)
                </button>
            </div>
        </form>
    </div>

    <div class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50 text-white font-bold" id="loading">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white mb-4"></div>
        <p id="loadingText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <script>
        // ‚úÖ 1. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Google Script (‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const CHECK_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxeDZPVdikGu9jbRGRgH5wckotJy4OHndOkFyQ0VyDdJDCzVsPcT_-UC9VaE87-S-Xc/exec';
        
        // ‚úÖ 2. ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Make (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
        const SUBMIT_WEBHOOK_URL = 'https://hook.eu1.make.com/9mgmk9fvut2zuu9ermdqocvkmnh5na9z';
        const IMGBB_API_KEY = '90bdd186ac4a75a080d137e88c123b84';

        function fileToBase64(file){
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = String(reader.result).split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function uploadToImgBB(file){
            const base64 = await fileToBase64(file);
            const fd = new FormData();
            fd.append('image', base64);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: fd
            });
            const data = await res.json();
            if(!data || !data.success) throw new Error('ImgBB upload failed');
            return data.data.url;
        }

        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const cleanParam = (v) => (v || '').toString().trim().replace(/^[\s(]+|[\s)]+$/g,'');
            const getParam = (k) => cleanParam(params.get(k));

            const currentCaseId = getParam('id');
            document.getElementById('showCaseId').innerText = currentCaseId || '-';
            document.getElementById('showName').innerText = getParam('name') || '-';
            document.getElementById('showDetail').innerText = getParam('detail') || '-';
            
            const phone = getParam('phone') || '';
            document.getElementById('callLink').innerText = phone;
            document.getElementById('callLink').href = 'tel:' + phone;

            document.getElementById('caseId').value = currentCaseId;
            document.getElementById('userId').value = (getParam('userid') || getParam('userId') || getParam('userID'));
            
            const lat = getParam('lat') || '';
            const lng = getParam('long') || '';
            let photo = getParam('photo') || getParam('photoUrl') || '';
            if(photo && !/^https?:\/\//i.test(photo)){
                photo = 'https://' + photo.replace(/^\/+/, '');
            }
            document.getElementById('lat').value = lat;
            document.getElementById('long').value = lng;
            document.getElementById('photoUrl').value = photo;

            // ... ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ...
            const issuePhoto = document.getElementById('issuePhoto');
            try{ issuePhoto.referrerPolicy = 'no-referrer'; }catch(e){}
            const noIssuePhoto = document.getElementById('noIssuePhoto');
            const issuePhotoError = document.getElementById('issuePhotoError');
            const issuePhotoOpen = document.getElementById('issuePhotoOpen');

            issuePhoto.classList.add('hidden');
            noIssuePhoto.classList.remove('hidden');
            if(issuePhotoError) issuePhotoError.classList.add('hidden');

            if(photo){
                issuePhoto.onload = function(){
                    issuePhoto.classList.remove('hidden');
                    noIssuePhoto.classList.add('hidden');
                    if(issuePhotoError) issuePhotoError.classList.add('hidden');
                };
                issuePhoto.onerror = function(){
                    if(!issuePhoto.dataset.triedProxy){
                        issuePhoto.dataset.triedProxy = '1';
                        const clean = photo.replace(/^https?:\/\//,'');
                        issuePhoto.src = 'https://images.weserv.nl/?url=' + encodeURIComponent(clean);
                        return;
                    }
                    issuePhoto.classList.add('hidden');
                    noIssuePhoto.classList.add('hidden');
                    if(issuePhotoError){
                        issuePhotoError.classList.remove('hidden');
                        if(issuePhotoOpen) issuePhotoOpen.href = photo;
                    }
                };
                issuePhoto.dataset.triedProxy = '';
                issuePhoto.src = photo;
            }
            
            const mapLink = document.getElementById('mapLink');
            const mapFrame = document.getElementById('mapFrame');
            const noLocation = document.getElementById('noLocation');
            if(lat && lng){
                const mapUrl = `https://www.google.com/maps?q=${lat},${lng}`;
                mapLink.href = mapUrl;
                mapFrame.src = `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
                mapFrame.classList.remove('hidden');
            } else {
                mapLink.href = '#';
                mapLink.classList.add('opacity-50','pointer-events-none');
                noLocation.classList.remove('hidden');
            }

            // üåü üåü üåü ‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö üåü üåü üåü
            if (currentCaseId) {
                document.getElementById('loadingText').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô...';
                document.getElementById('loading').classList.remove('hidden');
                
                try {
                    // ‡∏™‡πà‡∏á‡πÄ‡∏•‡∏Ç Case ID ‡πÑ‡∏õ‡∏ñ‡∏≤‡∏° Google Script
                    const res = await fetch(`${CHECK_WEBHOOK_URL}?id=${currentCaseId}`);
                    const data = await res.json();
                    
                    const btnAccept = document.getElementById('btnAccept');
                    const btnFinish = document.getElementById('btnFinish');

                    // ‡∏ñ‡πâ‡∏≤ Airtable ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô" ‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏∞‡∏Å‡∏î‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô Airtable)
                    if (data.status === '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô') {
                        btnFinish.disabled = true;
                        btnFinish.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow cursor-not-allowed flex justify-center items-center gap-2";
                        btnFinish.innerText = "‚úÖ ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß";
                        
                        btnAccept.disabled = true;
                        btnAccept.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow cursor-not-allowed flex justify-center items-center gap-2";
                        btnAccept.innerText = "üîí ‡πÄ‡∏Ñ‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
                    } 
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô", "‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" (‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
                    else if (data.status && data.status !== '‡∏£‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á' && data.status !== '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞' && data.status !== '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•') {
                        btnAccept.disabled = true;
                        btnAccept.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow cursor-not-allowed flex justify-center items-center gap-2";
                        btnAccept.innerText = "üöß ‡∏°‡∏µ‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
                    }
                } catch (e) {
                    console.error('Error fetching status', e);
                } finally {
                    document.getElementById('loading').classList.add('hidden');
                }
            }
        };

        async function submitForm(type) {
            document.getElementById('actionType').value = type; 
            
            if(type === 'finish') {
                const img = document.getElementById('imageInput');
                if(img.files.length === 0) { Swal.fire('‡∏•‡∏∑‡∏°‡∏£‡∏π‡∏õ', '‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); return; }
            }

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('loadingText').innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            document.getElementById('loading').classList.remove('hidden');
            
            const formData = new FormData(document.getElementById('techForm'));

            try {
                if(type === 'finish'){
                    const img = document.getElementById('imageInput');
                    const afterUrl = await uploadToImgBB(img.files[0]);
                    document.getElementById('afterPhotoUrl').value = afterUrl;

                    formData.set('afterPhotoUrl', afterUrl);
                    formData.delete('image');
                }

                // ‡∏™‡∏±‡πà‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Make (SUBMIT_WEBHOOK_URL)
                await fetch(SUBMIT_WEBHOOK_URL, { method: 'POST', body: formData });
                
                const btnAccept = document.getElementById('btnAccept');
                const btnFinish = document.getElementById('btnFinish');

                if (type === 'finish') {
                    btnFinish.disabled = true;
                    btnFinish.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow cursor-not-allowed flex justify-center items-center gap-2";
                    btnFinish.innerText = "‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
                    
                    btnAccept.disabled = true;
                    btnAccept.classList.add('opacity-50', 'cursor-not-allowed');
                } else if (type === 'accept') {
                    btnAccept.disabled = true;
                    btnAccept.className = "w-full bg-gray-400 text-white font-bold py-3 rounded-lg shadow cursor-not-allowed flex justify-center items-center gap-2";
                    btnAccept.innerText = "üöß ‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
                }

                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ä‡∏≤‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => window.close());
            } catch (err) {
                Swal.fire('Error', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
