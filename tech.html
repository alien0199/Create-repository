<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style> body { font-family: 'Kanit', sans-serif; } </style>
</head>
<body class="bg-blue-50 min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-md">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">üìù ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>
            
            <form id="repairForm" class="space-y-4">
                
                <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 shadow-sm">
                    <label class="block text-gray-700 font-bold mb-2">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏∞‡πÑ‡∏£? *</label>
                    <select name="category" id="category" required 
                            class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-lg">
                        <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏à‡∏¥‡πâ‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ --</option>
                        <option value="‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞">üí° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞ (‡πÑ‡∏ü‡∏î‡∏±‡∏ö/‡∏Å‡∏¥‡πà‡∏á‡πÑ‡∏°‡πâ‡∏û‡∏≤‡∏î)</option>
                        <option value="‡∏õ‡∏£‡∏∞‡∏õ‡∏≤/‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥">üö∞ ‡∏õ‡∏£‡∏∞‡∏õ‡∏≤ / ‡∏ó‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥</option>
                        <option value="‡∏ñ‡∏ô‡∏ô/‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤">üõ£Ô∏è ‡∏ñ‡∏ô‡∏ô / ‡∏ó‡∏≤‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option>
                        <option value="‡∏Ç‡∏¢‡∏∞/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î">üóëÔ∏è ‡∏Ç‡∏¢‡∏∞ / ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üìù ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á *</label>
                    <input type="text" name="name" id="name" required 
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ *</label>
                    <input type="tel" name="phone" id="phone" required 
                           class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ *</label>
                    <textarea name="detail" id="detail" rows="3" required 
                              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞ ‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï"></textarea>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-2">‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô *</label>
                    <div class="flex items-center justify-center w-full">
                        <label class="flex flex-col w-full h-32 border-4 border-blue-200 border-dashed hover:bg-gray-100 hover:border-gray-300 rounded-lg cursor-pointer">
                            <div class="flex flex-col items-center justify-center pt-7">
                                <p class="pt-1 text-sm tracking-wider text-gray-400">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ üì∏</p>
                            </div>
                            <input type="file" name="image" id="imageInput" class="hidden" accept="image/*" capture="environment" onchange="previewImage(event)" required />
                <input type="hidden" name="photoUrl" id="photoUrl">
                        </label>
                    </div>
                    <img id="preview" class="hidden w-full mt-4 rounded-lg shadow-md border border-gray-200" />
                </div>

                <div>
                    <button type="button" onclick="getLocation()" 
                            class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex justify-center items-center gap-2">
                        üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS
                    </button>
                    <p id="locationStatus" class="text-sm text-gray-500 mt-2 text-center"></p>
                    <input type="hidden" name="lat" id="lat">
                    <input type="hidden" name="long" id="long">
                    <input type="hidden" name="userId" id="userId">
                </div>

                <button type="submit" id="submitBtn" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg mt-6 transform transition hover:scale-105">
                    üöÄ ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°
                </button>
            </form>
        </div>
        <p class="text-center text-gray-500 text-xs mt-4">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏• by Nayak Pong</p>
    </div>
    
    <div id="loading" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <script>
        // ‚úÖ ‡∏ú‡∏°‡πÉ‡∏™‡πà‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå Webhook ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ
        const WEBHOOK_URL = 'https://hook.eu1.make.com/8uj45pto8ouoba79ndgs8urhwork3ame';

        // ‚úÖ ‡πÉ‡∏™‡πà API Key ‡∏Ç‡∏≠‡∏á ImgBB (‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏Ñ‡∏µ‡∏¢‡πå‡∏ô‡∏µ‡πâ)
        const IMGBB_API_KEY = '90bdd186ac4a75a080d137e88c123b84';

        function fileToBase64(file){
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = String(reader.result).split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function uploadToImgBB(file){
            const base64 = await fileToBase64(file);
            const fd = new FormData();
            fd.append('image', base64);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: fd
            });
            const data = await res.json();
            if(!data || !data.success) throw new Error('ImgBB upload failed');
            return data.data.url;
        }
 

        window.onload = function() { initializeLiff(); };

        function previewImage(event) {
            const file = event.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onload = function(){
                    const output = document.getElementById('preview');
                    output.src = reader.result;
                    output.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        function getLocation() {
            const status = document.getElementById('locationStatus');
            if (navigator.geolocation) {
                status.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...";
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else { status.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"; }
        }

        function showPosition(position) {
            document.getElementById('lat').value = position.coords.latitude;
            document.getElementById('long').value = position.coords.longitude;
            document.getElementById('locationStatus').innerHTML = "‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            document.getElementById('locationStatus').className = "text-sm text-green-600 mt-2 text-center font-bold";
        }

        function showError(error) {
            document.getElementById('locationStatus').innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS)";
        }

        async function initializeLiff() {
            try {
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    document.getElementById('userId').value = profile.userId;
                }
            } catch (err) { console.log(err); }
        }

        document.getElementById('repairForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const category = document.getElementById('category').value;
            if(!category) { Swal.fire('‡∏•‡∏∑‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); return; }

            const imageInput = document.getElementById('imageInput');
            if(imageInput.files.length === 0){ Swal.fire('‡∏•‡∏∑‡∏°‡∏£‡∏π‡∏õ', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); return; }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;

            const formData = new FormData(this);
            try {
                // ‚úÖ 1) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ ImgBB ‡∏Å‡πà‡∏≠‡∏ô (‡∏•‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏Ç‡∏≠‡∏á Make/Airtable)
                const url = await uploadToImgBB(imageInput.files[0]);
                document.getElementById('photoUrl').value = url;

                // ‚úÖ 2) ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Make ‡πÅ‡∏ö‡∏ö ‚Äú‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‚Äù (‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà URL)
                formData.set('photoUrl', url);
                formData.delete('image');

                const response = await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
                if (response.ok) {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => {
                        if (liff.isInClient()) { liff.closeWindow(); } else { window.location.reload(); }
                    });
                } else { throw new Error('Error'); }
            } catch (error) {
                Swal.fire('‡πÅ‡∏¢‡πà‡πÅ‡∏•‡πâ‡∏ß', '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ', 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('submitBtn').disabled = false;
            }
        });
    </script>
</body>
</html>
